// api/webhook.js
import { Telegraf } from 'telegraf';

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–æ—Ç–∞
const bot = new Telegraf(process.env.BOT_TOKEN);

// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É /start
bot.command('start', (ctx) => {
  console.log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${ctx.from.id} –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞`);
  ctx.reply(`üé® –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–∫—Å—Ç—É—Ä. –ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Ñ–æ—Ç–æ.`);
});

// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
bot.on('text', (ctx) => {
  ctx.reply('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é üì∏');
});

// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–æ—Ç–æ
bot.on('photo', async (ctx) => {
  const msg = await ctx.reply('‚è≥ –ü–æ–ª—É—á–∏–ª —Ñ–æ—Ç–æ, –Ω–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É...');
  // –ó–¥–µ—Å—å –ø–æ–∑–∂–µ –±—É–¥–µ—Ç –≤–∞—à–∞ –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  setTimeout(() => {
    ctx.telegram.editMessageText(
      ctx.chat.id,
      msg.message_id,
      null,
      '‚úÖ –§–æ—Ç–æ –ø–æ–ª—É—á–µ–Ω–æ! (–ó–∞–≥–ª—É—à–∫–∞: –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç)'
    );
  }, 1000);
});

// --- –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–ê–Ø –ß–ê–°–¢–¨: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è Vercel ---
export default async (req, res) => {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç–æ–¥ –∑–∞–ø—Ä–æ—Å–∞
    if (req.method === 'POST') {
      // –¢–µ–ª–µ–≥—Ä–∞–º –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞
      const update = req.body;
      console.log('–ü–æ–ª—É—á–µ–Ω update –æ—Ç Telegram:', update.update_id);

      // –ü–µ—Ä–µ–¥–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–æ—Ç—É –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É
      await bot.handleUpdate(update);
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¢–µ–ª–µ–≥—Ä–∞–º—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, —á—Ç–æ –≤—Å–µ –æ–∫
      return res.status(200).json({ ok: true });
    } else {
      // –ï—Å–ª–∏ GET-–∑–∞–ø—Ä–æ—Å (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞) - –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—á–∞–µ–º
      return res.status(200).send('ü§ñ –ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ POST –¥–ª—è –≤–µ–±—Ö—É–∫–∞.');
    }
  } catch (error) {
    // –õ–æ–≥–∏—Ä—É–µ–º –ª—é–±—É—é –æ—à–∏–±–∫—É
    console.error('–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –≤–µ–±—Ö—É–∫–∞:', error);
    return res.status(500).json({ error: 'Internal Server Error' });
  }
};
