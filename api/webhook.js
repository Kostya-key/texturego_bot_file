// api/webhook.js

// 1. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
import { Telegraf } from 'telegraf';

// 2. –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É—è —Ç–æ–∫–µ–Ω –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è Vercel
const bot = new Telegraf(process.env.BOT_TOKEN);

// 3. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É /start
bot.command('start', (ctx) => {
  ctx.reply(
    `üé® –ü—Ä–∏–≤–µ—Ç, ${ctx.from.first_name}! –Ø TextureBot.\n\n` +
    `–û—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Ñ–æ—Ç–æ –ª—é–±–æ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ (—Å—Ç–µ–Ω–∞, –¥–µ—Ä–µ–≤–æ, —Ç–∫–∞–Ω—å), –∏ —è –ø–æ–ø—Ä–æ–±—É—é —Å–æ–∑–¥–∞—Ç—å –∏–∑ –Ω–µ–≥–æ —Ç–µ–∫—Å—Ç—É—Ä—É.\n\n` +
    `–ü—Ä–æ—Å—Ç–æ —Å–∫–∏–Ω—å —Ñ–æ—Ç–æ —Å—é–¥–∞!`
  );
});

// 4. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ª—é–±–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –∫–æ–º–∞–Ω–¥–∞)
bot.on('text', (ctx) => {
  ctx.reply('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Ñ–æ—Ç–æ üì∏');
});

// 5. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ —Ñ–æ—Ç–æ
bot.on('photo', async (ctx) => {
  // 5.1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é..."
  const processingMsg = await ctx.reply('‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ñ–æ—Ç–æ...');

  try {
    // 5.2. –ü–æ–ª—É—á–∞–µ–º file_id —Å–∞–º–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Ñ–æ—Ç–æ (–ø–æ—Å–ª–µ–¥–Ω–∏–π –≤ –º–∞—Å—Å–∏–≤–µ)
    const fileId = ctx.message.photo[ctx.message.photo.length - 1].file_id;
    
    // 5.3. –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
    const fileInfo = await ctx.telegram.getFile(fileId);
    
    // 5.4. –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
    const fileUrl = `https://api.telegram.org/file/bot${process.env.BOT_TOKEN}/${fileInfo.file_path}`;
    
    // 5.5. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
    // (–ó–î–ï–°–¨ –ë–£–î–ï–¢ –ú–ï–°–¢–û –î–õ–Ø –í–ê–®–ï–ì–û –ê–õ–ì–û–†–ò–¢–ú–ê –û–ë–†–ê–ë–û–¢–ö–ò –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø)
    
    // 5.6. –ü–æ–∫–∞ —á—Ç–æ –ø—Ä–æ—Å—Ç–æ —Å–æ–æ–±—â–∞–µ–º, —á—Ç–æ —Ñ–æ—Ç–æ –ø–æ–ª—É—á–µ–Ω–æ
    await ctx.telegram.editMessageText(
      ctx.chat.id,
      processingMsg.message_id,
      null,
      `‚úÖ –§–æ—Ç–æ –ø–æ–ª—É—á–µ–Ω–æ! (–†–∞–∑–º–µ—Ä: ${fileInfo.file_size} –±–∞–π—Ç)\n\n` +
      `–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∞–π–ª: ${fileUrl}\n\n` +
      `*–≠—Ç–æ MVP-–≤–µ—Ä—Å–∏—è. –°–∫–æ—Ä–æ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞—è —Ç–µ–∫—Å—Ç—É—Ä–∞!*`,
      { parse_mode: 'Markdown' }
    );
    
    // 5.7. –ü—Ä–æ—Å–∏–º —Å–ª–µ–¥—É—é—â–µ–µ —Ñ–æ—Ç–æ
    ctx.reply('–ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–ª–µ–¥—É—é—â–µ–µ —Ñ–æ—Ç–æ üì∏');
    
  } catch (error) {
    // 5.8. –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, —Å–æ–æ–±—â–∞–µ–º –æ–± –æ—à–∏–±–∫–µ
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ:', error);
    await ctx.telegram.editMessageText(
      ctx.chat.id,
      processingMsg.message_id,
      null,
      '‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.'
    );
  }
});

// 6. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–æ–∫—É–º–µ–Ω—Ç—ã, —Å—Ç–∏–∫–µ—Ä—ã –∏ —Ç.–¥.)
bot.on('message', (ctx) => {
  ctx.reply('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–º–µ–Ω–Ω–æ —Ñ–æ—Ç–æ (–Ω–µ –¥–æ–∫—É–º–µ–Ω—Ç –∏ –Ω–µ —Å—Ç–∏–∫–µ—Ä) üì∏');
});

// 7. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –±–æ—Ç–∞
bot.catch((err, ctx) => {
  console.error(`–û—à–∏–±–∫–∞ –¥–ª—è —á–∞—Ç–∞ ${ctx.chat.id}:`, err);
  ctx.reply('–£–ø—Å, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
});

// 8. –ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç Telegram (—á–µ—Ä–µ–∑ –≤–µ–±—Ö—É–∫)
// –≠—Ç–æ—Ç —ç–∫—Å–ø–æ—Ä—Ç –î–û–õ–ñ–ï–ù –Ω–∞–∑—ã–≤–∞—Ç—å—Å—è –∏–º–µ–Ω–Ω–æ "default" –¥–ª—è Vercel
export default async (req, res) => {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
    if (!process.env.BOT_TOKEN) {
      console.error('–û–®–ò–ë–ö–ê: –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!');
      return res.status(500).json({ error: 'Server configuration error' });
    }

    // –î–ª—è GET-–∑–∞–ø—Ä–æ—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ) –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
    if (req.method === 'GET') {
      return res.status(200).send(`
        <html>
          <body>
            <h1>‚úÖ Texture Bot —Ä–∞–±–æ—Ç–∞–µ—Ç!</h1>
            <p>Telegram –≤–µ–±—Ö—É–∫ –∞–∫—Ç–∏–≤–µ–Ω.</p>
            <p>–û—Ç–ø—Ä–∞–≤—å—Ç–µ /start –≤–∞—à–µ–º—É –±–æ—Ç—É –≤ Telegram.</p>
            <p>–¢–æ–∫–µ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω: ${process.env.BOT_TOKEN ? '–î–∞' : '–ù–µ—Ç'}</p>
          </body>
        </html>
      `);
    }

    // –î–ª—è POST-–∑–∞–ø—Ä–æ—Å–æ–≤ (—Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç Telegram) –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    if (req.method === 'POST') {
      const update = req.body;
      await bot.handleUpdate(update);
      return res.status(200).send('OK');
    }

    // –î–ª—è –≤—Å–µ—Ö –¥—Ä—É–≥–∏—Ö –º–µ—Ç–æ–¥–æ–≤ HTTP –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É
    return res.status(405).send('Method Not Allowed');
    
  } catch (error) {
    console.error('–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ:', error);
    return res.status(500).json({ error: 'Internal Server Error' });
  }
};
